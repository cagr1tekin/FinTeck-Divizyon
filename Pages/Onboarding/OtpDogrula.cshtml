@page
@model InteraktifKredi.Pages.Onboarding.OtpDogrulaModel
@{
    ViewData["Title"] = "OTP Doğrulama";
}

<div class="onboarding_container">
    <div class="onboarding_card">
        <div class="onboarding_card__header">
            <h1 class="onboarding_title">Doğrulama Kodu</h1>
            <p class="onboarding_subtitle">SMS ile gönderilen 6 haneli kodu girin</p>
            @if (!string.IsNullOrEmpty(Model.MaskedGsm))
            {
                <p class="onboarding_phone">@Model.MaskedGsm</p>
            }
        </div>

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="form_error_message @(Model.RetryCount >= 3 ? "form_error_message--warning" : "")">
                <span class="form_error_message__icon">⚠</span>
                <span class="form_error_message__text">@Model.ErrorMessage</span>
            </div>
        }

        <form id="otp_form" method="post" class="onboarding_form" novalidate>
            <div class="form_group">
                <div class="otp_inputs" id="otp_inputs">
                    <input type="text" class="otp_input" id="otp_1" maxlength="1" inputmode="numeric" autocomplete="off" data-otp-mask />
                    <input type="text" class="otp_input" id="otp_2" maxlength="1" inputmode="numeric" autocomplete="off" data-otp-mask />
                    <input type="text" class="otp_input" id="otp_3" maxlength="1" inputmode="numeric" autocomplete="off" data-otp-mask />
                    <input type="text" class="otp_input" id="otp_4" maxlength="1" inputmode="numeric" autocomplete="off" data-otp-mask />
                    <input type="text" class="otp_input" id="otp_5" maxlength="1" inputmode="numeric" autocomplete="off" data-otp-mask />
                    <input type="text" class="otp_input" id="otp_6" maxlength="1" inputmode="numeric" autocomplete="off" data-otp-mask />
                </div>
                <input type="hidden" asp-for="OtpCode" id="otp_code_hidden" />
                <span asp-validation-for="OtpCode" class="form_error"></span>
            </div>

            <div class="otp_timer" id="otp_timer">
                <span class="otp_timer__text">Kod tekrar gönderilebilir:</span>
                <span class="otp_timer__countdown" id="timer_countdown">1:00</span>
            </div>

            <div class="otp_resend" id="otp_resend" style="display: none;">
                <a href="#" id="resend_otp_link" class="onboarding_footer__link">Kodu Tekrar Gönder</a>
            </div>

            <div class="form_group">
                <button type="submit" id="submit_btn" class="btn_primary btn_primary--full_width">
                    <span class="btn_primary__text">Doğrula</span>
                </button>
            </div>
        </form>

        <div class="onboarding_footer">
            <p class="onboarding_footer__text">
                <a href="#" id="resend_otp_link_footer" class="onboarding_footer__link onboarding_footer__link--disabled">Tekrar gönder</a>
            </p>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            var $form = $('#otp_form');
            var $otpInputs = $('.otp_input');
            var $otpCodeHidden = $('#otp_code_hidden');
            var $submitBtn = $('#submit_btn');
            var $btnText = $submitBtn.find('.btn_primary__text');
            var $timer = $('#otp_timer');
            var $timerCountdown = $('#timer_countdown');
            var $resendLink = $('#resend_otp_link');
            var $resendLinkFooter = $('#resend_otp_link_footer');
            var $resendContainer = $('#otp_resend');
            var $otpInputsContainer = $('#otp_inputs');
            
            var timerSeconds = 60; // 1 dakika
            var timerInterval = null;
            var retryCount = @Model.RetryCount;

            // Footer link başlangıçta disabled
            $resendLinkFooter.addClass('onboarding_footer__link--disabled').prop('disabled', true);
            
            // Timer başlat
            startTimer();

            // OTP maskeleme - gerçek değeri sakla, görünen değeri maskele
            $otpInputs.each(function() {
                var $input = $(this);
                $input.data('real-value', '');
                
                // Focus olduğunda gerçek değeri göster
                $input.on('focus', function() {
                    var realValue = $(this).data('real-value');
                    if (realValue) {
                        $(this).val(realValue);
                    }
                });
                
                // Blur olduğunda maskele
                $input.on('blur', function() {
                    var realValue = $(this).data('real-value');
                    if (realValue) {
                        $(this).val('●');
                    }
                });
            });

            // OTP input focus geçişi
            $otpInputs.on('input', function() {
                var $this = $(this);
                var value = $this.val().replace(/\D/g, '');
                
                if (value.length > 0) {
                    var digit = value.charAt(0);
                    $this.data('real-value', digit);
                    $this.val('●'); // Maskele
                    
                    // Sonraki input'a geç
                    var index = $otpInputs.index($this);
                    if (index < $otpInputs.length - 1) {
                        $otpInputs.eq(index + 1).focus();
                    } else {
                        // Son input dolduruldu, form'u submit et
                        updateOtpCode();
                        $form.submit();
                    }
                } else {
                    $this.val('');
                    $this.data('real-value', '');
                }
                
                updateOtpCode();
            });

            // Backspace ile geri gitme
            $otpInputs.on('keydown', function(e) {
                var $this = $(this);
                var index = $otpInputs.index($this);
                
                if (e.key === 'Backspace') {
                    if ($this.data('real-value') || $this.val()) {
                        $this.val('');
                        $this.data('real-value', '');
                        updateOtpCode();
                    } else if (index > 0) {
                        $otpInputs.eq(index - 1).focus().val('').data('real-value', '');
                        updateOtpCode();
                    }
                }
            });

            // Paste desteği
            $otpInputs.on('paste', function(e) {
                e.preventDefault();
                var pasteData = (e.originalEvent.clipboardData || window.clipboardData).getData('text');
                pasteData = pasteData.replace(/\D/g, '').substring(0, 6);
                
                if (pasteData.length > 0) {
                    var index = $otpInputs.index($(this));
                    for (var i = 0; i < pasteData.length && (index + i) < $otpInputs.length; i++) {
                        var digit = pasteData.charAt(i);
                        $otpInputs.eq(index + i).data('real-value', digit).val('●');
                    }
                    updateOtpCode();
                    
                    // Son input'a focus
                    var lastIndex = Math.min(index + pasteData.length - 1, $otpInputs.length - 1);
                    $otpInputs.eq(lastIndex).focus();
                }
            });

            // OTP kodunu hidden input'a yaz
            function updateOtpCode() {
                var otpCode = '';
                $otpInputs.each(function() {
                    var realValue = $(this).data('real-value') || '';
                    otpCode += realValue;
                });
                $otpCodeHidden.val(otpCode);
                
                // 6 karakter dolduysa success state
                if (otpCode.length === 6) {
                    $otpInputsContainer.addClass('otp_inputs--success');
                } else {
                    $otpInputsContainer.removeClass('otp_inputs--success');
                }
            }

            // Timer başlat
            function startTimer() {
                timerSeconds = 60; // 1 dakika
                updateTimerDisplay();
                
                $timer.show();
                $resendContainer.hide();
                
                // Footer linkini saydam yap (disabled state)
                $resendLinkFooter.addClass('onboarding_footer__link--disabled')
                    .prop('disabled', true)
                    .off('click');
                
                $resendLink.prop('disabled', true);
                
                timerInterval = setInterval(function() {
                    timerSeconds--;
                    updateTimerDisplay();
                    
                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        $timer.hide();
                        $resendContainer.show();
                        
                        // Footer linkini aktif yap
                        $resendLinkFooter.removeClass('onboarding_footer__link--disabled')
                            .prop('disabled', false)
                            .on('click', function(e) {
                                e.preventDefault();
                                resendOtp();
                            });
                        
                        $resendLink.prop('disabled', false);
                    }
                }, 1000);
            }

            // Timer görünümünü güncelle
            function updateTimerDisplay() {
                var minutes = Math.floor(timerSeconds / 60);
                var seconds = timerSeconds % 60;
                $timerCountdown.text(minutes + ':' + (seconds < 10 ? '0' : '') + seconds);
            }

            // Tekrar gönder
            $resendLink.on('click', function(e) {
                e.preventDefault();
                if (!$resendLink.prop('disabled')) {
                    resendOtp();
                }
            });

            $resendLinkFooter.on('click', function(e) {
                e.preventDefault();
                if (!$resendLinkFooter.prop('disabled')) {
                    resendOtp();
                }
            });

            function resendOtp() {
                var tckn = '@Model.Tckn';
                var gsm = '@Model.Gsm';
                
                if (!tckn || !gsm) {
                    show_toast('Bilgiler bulunamadı. Lütfen tekrar giriş yapın.', 'error');
                    return;
                }

                // Footer linkini disabled yap
                $resendLinkFooter.addClass('onboarding_footer__link--disabled')
                    .prop('disabled', true)
                    .off('click')
                    .text('Gönderiliyor...');
                
                $resendLink.prop('disabled', true).text('Gönderiliyor...');
                
                // OTP oluştur ve SMS gönder
                $.ajax({
                    url: '/api/otp/generate',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ TCKN: tckn, GSM: gsm }),
                    success: function(response) {
                        if (response.success && response.value) {
                            // OTPCode veya otpCode olabilir
                            var otpCode = response.value.OTPCode || response.value.otpCode || response.value.OtpCode;
                            
                            if (!otpCode) {
                                show_toast('OTP kodu alınamadı.', 'error');
                                enableResendLinks();
                                return;
                            }
                            
                            // SMS gönder
                            $.ajax({
                                url: '/api/otp/send-sms',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({ 
                                    GSM: gsm, 
                                    OtpCode: otpCode 
                                }),
                                success: function(smsResponse) {
                                    if (smsResponse.success) {
                                        show_toast('Yeni kod gönderildi.', 'success');
                                        // Input'ları temizle
                                        $otpInputs.val('').data('real-value', '').first().focus();
                                        updateOtpCode();
                                        // Timer'ı yeniden başlat (60 saniye)
                                        startTimer();
                                    } else {
                                        show_toast(smsResponse.message || 'SMS gönderilemedi.', 'error');
                                        enableResendLinks();
                                    }
                                },
                                error: function() {
                                    show_toast('SMS gönderilirken bir hata oluştu.', 'error');
                                    enableResendLinks();
                                }
                            });
                        } else {
                            show_toast(response.message || 'OTP oluşturulamadı.', 'error');
                            enableResendLinks();
                        }
                    },
                    error: function() {
                        show_toast('Bir hata oluştu. Lütfen tekrar deneyin.', 'error');
                        enableResendLinks();
                    }
                });
            }
            
            // Resend linklerini aktif et helper fonksiyonu
            function enableResendLinks() {
                $resendLinkFooter.removeClass('onboarding_footer__link--disabled')
                    .prop('disabled', false)
                    .text('Tekrar gönder')
                    .on('click', function(e) {
                        e.preventDefault();
                        resendOtp();
                    });
                
                $resendLink.prop('disabled', false).text('Kodu Tekrar Gönder');
            }

            // Form submit
            $form.on('submit', function(e) {
                e.preventDefault();

                updateOtpCode();
                var otpCode = $otpCodeHidden.val();

                if (otpCode.length !== 6) {
                    show_toast('Lütfen 6 haneli kodu girin.', 'error');
                    $otpInputsContainer.addClass('otp_inputs--error');
                    setTimeout(function() {
                        $otpInputsContainer.removeClass('otp_inputs--error');
                    }, 2000);
                    return false;
                }

                // Butonu disable et
                $submitBtn.prop('disabled', true)
                    .addClass('btn_primary--loading');
                $btnText.text('Doğrulanıyor...');

                // Form submit (server-side)
                $form.off('submit').submit();
            });

            // İlk yüklemede mevcut değerleri maskele
            $otpInputs.each(function() {
                var $input = $(this);
                var currentValue = $input.val();
                if (currentValue) {
                    $input.data('real-value', currentValue);
                    $input.val('●');
                }
            });
            
            // İlk input'a focus
            $otpInputs.first().focus();
        });
    </script>
}

