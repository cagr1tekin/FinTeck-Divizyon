@page
@model InteraktifKredi.Pages.Onboarding.TcknGsmModel
@{
    ViewData["Title"] = "TCKN ve GSM Doğrulama";
}

<div class="onboarding_container">
    <div class="onboarding_card">
        <div class="onboarding_card__header">
            <h1 class="onboarding_title">Hoş Geldiniz</h1>
            <p class="onboarding_subtitle">Kimlik bilgilerinizi girin</p>
        </div>

        <form id="tckn_gsm_form" method="post" class="onboarding_form" novalidate>
            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <div class="form_error_message">
                    <span class="form_error_message__icon">⚠</span>
                    <span class="form_error_message__text">@Model.ErrorMessage</span>
                </div>
            }

            <div class="form_group">
                <label asp-for="Tckn" class="form_label form_label--required">TC Kimlik No</label>
                <input 
                    asp-for="Tckn" 
                    id="tckn_input"
                    class="form_input" 
                    type="text" 
                    inputmode="numeric"
                    maxlength="11" 
                    placeholder="11 haneli TCKN"
                    autocomplete="off"
                    data-mask="tckn"
                    required />
                <span asp-validation-for="Tckn" class="form_error"></span>
            </div>

            <div class="form_group">
                <label asp-for="Gsm" class="form_label form_label--required">GSM Numarası</label>
                <input 
                    asp-for="Gsm" 
                    id="gsm_input"
                    class="form_input" 
                    type="tel" 
                    inputmode="numeric"
                    maxlength="11" 
                    placeholder="5XX XXX XX XX"
                    autocomplete="tel"
                    data-mask="phone"
                    required />
                <span asp-validation-for="Gsm" class="form_error"></span>
            </div>

            <div class="form_group">
                <a href="#" id="kvkk_link" class="kvkk_link">KVKK metnine buradan ulaşabilirsiniz</a>
            </div>

            <div class="form_group">
                <button type="submit" id="submit_btn" class="btn_primary btn_primary--full_width">
                    <span class="btn_primary__text">Devam Et</span>
                </button>
            </div>
        </form>

        <div class="onboarding_footer">
            <p class="onboarding_footer__text">
                Bilgileriniz güvenli bir şekilde işlenmektedir.
            </p>
        </div>
    </div>
</div>

<!-- KVKK Modal -->
<div class="modal" id="kvkk_modal">
    <div class="modal__overlay"></div>
    <div class="modal__container modal__container--lg">
        <div class="modal__header">
            <div>
                <h2 class="modal__title" id="kvkk_modal_title">KVKK Aydınlatma Metni</h2>
            </div>
            <button type="button" class="modal_close" id="kvkk_modal_close" aria-label="Kapat"></button>
        </div>
        <div class="modal__body">
            <div class="kvkk_modal_content" id="kvkk_modal_content">
                <div class="kvkk_modal_loading">
                    <div class="kvkk_modal_loading__spinner"></div>
                    <p>KVKK metni yükleniyor...</p>
                </div>
            </div>
        </div>
        <div class="modal__footer">
            <label class="kvkk_modal_checkbox">
                <input type="checkbox" id="kvkk_accept_checkbox" class="kvkk_modal_checkbox__input" />
                <span class="kvkk_modal_checkbox__label">
                    <strong>Okudum, Onaylıyorum</strong>
                </span>
            </label>
            <button type="button" id="kvkk_accept_btn" class="btn_primary" disabled>
                <span class="btn_primary__text">Onayla ve Kapat</span>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            var $form = $('#tckn_gsm_form');
            var $tcknInput = $('#tckn_input');
            var $gsmInput = $('#gsm_input');
            var $submitBtn = $('#submit_btn');
            var $btnText = $submitBtn.find('.btn_primary__text');

            // Input masking artık aşağıdaki event handler'larda yapılıyor

            // Input değişikliklerinde buton durumunu güncelle
            $tcknInput.on('input', function() {
                updateSubmitButtonState();
            });

            $gsmInput.on('input', function() {
                updateSubmitButtonState();
            });

            // Form submit
            $form.on('submit', function(e) {
                e.preventDefault();

                // KVKK onayı kontrolü
                if (!kvkkAccepted) {
                    show_toast('KVKK aydınlatma metnini okudum ve onaylıyorum seçeneğini işaretlemelisiniz.', 'error');
                    return false;
                }

                // Client-side validation
                if (!$form[0].checkValidity()) {
                    $form[0].reportValidity();
                    return false;
                }

                var tckn = $tcknInput.val().trim();
                var gsm = $gsmInput.val().trim();

                // TCKN validation
                if (tckn.length !== 11 || !/^\d+$/.test(tckn)) {
                    show_toast('TC Kimlik No 11 haneli olmalıdır.', 'error');
                    $tcknInput.focus();
                    return false;
                }

                // GSM validation
                if (gsm.length < 10 || gsm.length > 11 || !/^5\d{9,10}$/.test(gsm)) {
                    show_toast('GSM numarası 5 ile başlamalı ve 10-11 haneli olmalıdır.', 'error');
                    $gsmInput.focus();
                    return false;
                }

                // Butonu disable et
                $submitBtn.prop('disabled', true)
                    .addClass('btn_primary--loading');
                $btnText.text('Doğrulanıyor...');

                // Form submit (server-side)
                $form.off('submit').submit();
            });

            // Enter tuşu ile submit
            $tcknInput.on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $gsmInput.focus();
                }
            });

            $gsmInput.on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $form.submit();
                }
            });

            // KVKK Modal
            var $kvkkLink = $('#kvkk_link');
            var $kvkkModal = $('#kvkk_modal');
            var $kvkkModalOverlay = $kvkkModal.find('.modal__overlay');
            var $kvkkModalClose = $('#kvkk_modal_close');
            var $kvkkModalContent = $('#kvkk_modal_content');
            var $kvkkAcceptCheckbox = $('#kvkk_accept_checkbox');
            var $kvkkAcceptBtn = $('#kvkk_accept_btn');
            var kvkkAccepted = false;

            // KVKK link'ine tıklanınca modal aç
            $kvkkLink.on('click', function(e) {
                e.preventDefault();
                openKvkkModal();
            });

            // Modal aç
            function openKvkkModal() {
                // Checkbox ve buton durumunu sıfırla
                $kvkkAcceptCheckbox.prop('checked', false);
                $kvkkAcceptBtn.prop('disabled', true);
                kvkkAccepted = false;
                updateSubmitButtonState();
                
                $kvkkModal.addClass('modal--visible');
                $('body').addClass('modal_open');
                loadKvkkText();
            }

            // Modal kapat
            function closeKvkkModal() {
                $kvkkModal.removeClass('modal--visible');
                $('body').removeClass('modal_open');
            }

            // Close butonuna tıklanınca kapat (her zaman çalışır)
            $kvkkModalClose.on('click', function(e) {
                e.preventDefault();
                closeKvkkModal();
            });

            // Overlay'e tıklanınca kapat (her zaman çalışır, ama onaylanmamışsa uyarı gösterilebilir)
            $kvkkModalOverlay.on('click', function(e) {
                if ($(e.target).is($kvkkModalOverlay)) {
                    // Onaylanmamışsa modal kapanmasın (kullanıcı okusun)
                    if (!kvkkAccepted) {
                        return;
                    }
                    closeKvkkModal();
                }
            });

            // ESC tuşu ile kapat (sadece onaylanmışsa)
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && $kvkkModal.hasClass('modal--visible')) {
                    // Onaylanmamışsa modal kapanmasın
                    if (!kvkkAccepted) {
                        return;
                    }
                    closeKvkkModal();
                }
            });

            // Checkbox değişikliğinde buton durumunu güncelle
            $kvkkAcceptCheckbox.on('change', function() {
                kvkkAccepted = $(this).is(':checked');
                $kvkkAcceptBtn.prop('disabled', !kvkkAccepted);
                updateSubmitButtonState(); // Devam Et butonunu da güncelle
            });

            // Onayla butonuna tıklanınca
            $kvkkAcceptBtn.on('click', function(e) {
                e.preventDefault();
                if (kvkkAccepted) {
                    closeKvkkModal();
                    // Devam Et butonuna tıkla
                    setTimeout(function() {
                        $submitBtn.click();
                    }, 300);
                }
            });

            // Submit buton durumunu güncelle
            function updateSubmitButtonState() {
                // KVKK onayı kontrolü
                if (!kvkkAccepted) {
                    $submitBtn.prop('disabled', true);
                    return;
                }
                
                // Diğer validasyonları da kontrol et
                var tckn = $tcknInput.val().trim();
                var gsm = $gsmInput.val().trim();
                var isValid = tckn.length === 11 && /^\d+$/.test(tckn) && 
                              gsm.length >= 10 && gsm.length <= 11 && /^5\d{9,10}$/.test(gsm);
                $submitBtn.prop('disabled', !isValid);
            }

            // Sayfa yüklendiğinde buton durumunu kontrol et
            updateSubmitButtonState();

            // KVKK metnini yükle
            function loadKvkkText() {
                $kvkkModalContent.html('<div class="kvkk_modal_loading"><div class="kvkk_modal_loading__spinner"></div><p>KVKK metni yükleniyor...</p></div>');

                $.ajax({
                    url: '/api/kvkk/text/1',
                    method: 'GET',
                    contentType: 'application/json',
                    success: function(response) {
                        if (response.success && response.value) {
                            // Response'dan Text alanını al (HTML olarak geliyor)
                            var kvkkHtml = response.value;
                            
                            // className'leri class'a çevir (React syntax'ını HTML'e çevir)
                            kvkkHtml = kvkkHtml.replace(/className=/g, 'class=');
                            
                            // KVKK başlığını güncelle
                            if (response.name) {
                                $('#kvkk_modal_title').text(response.name);
                            }
                            
                            // HTML'i direkt render et (güvenli olduğu için)
                            $kvkkModalContent.html('<div class="kvkk_modal_text">' + kvkkHtml + '</div>');
                        } else {
                            $kvkkModalContent.html('<div class="kvkk_modal_error">KVKK metni yüklenemedi. Lütfen tekrar deneyin.</div>');
                            show_toast(response.message || 'KVKK metni yüklenemedi.', 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        $kvkkModalContent.html('<div class="kvkk_modal_error">KVKK metni yüklenirken bir hata oluştu. Lütfen tekrar deneyin.</div>');
                        show_toast('KVKK metni yüklenirken bir hata oluştu.', 'error');
                        console.error('KVKK metni yükleme hatası:', error);
                    }
                });
            }
        });
    </script>
}
