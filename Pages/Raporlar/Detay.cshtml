@page
@model InteraktifKredi.Pages.Raporlar.DetayModel
@{
    ViewData["Title"] = "Rapor Detayı";
}

<div class="report_detail_container">
    <!-- Geri Butonu -->
    <div class="report_detail__back">
        <a href="/Raporlar/Liste" class="btn_ghost">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Geri Dön
        </a>
    </div>

    @if (Model.IsLoading)
    {
        <div class="report_detail__loading">
            <div class="report_detail__loading__spinner"></div>
            <p class="report_detail__loading__text">Rapor detayı yükleniyor...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="form_error_message">
            <span class="form_error_message__icon">⚠</span>
            <span class="form_error_message__text">@Model.ErrorMessage</span>
        </div>
    }
    else if (Model.ReportDetail == null)
    {
        <div class="report_detail__empty">
            <div class="report_detail__empty__icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
            </div>
            <h3 class="report_detail__empty__title">Rapor bulunamadı</h3>
            <p class="report_detail__empty__text">Aradığınız rapor bulunamadı veya erişim yetkiniz yok.</p>
        </div>
    }
    else
    {
        var report = Model.ReportDetail;
        
        <!-- Rapor Başlığı -->
        <div class="report_detail__header">
            <h1 class="report_detail__title">@report.ReportTitle</h1>
            <div class="report_detail__header__meta">
                <span class="report_detail__badge report_detail__badge--@GetStatusClass(report.Status)">
                    @report.StatusText
                </span>
                <span class="report_detail__date">@report.ReportDate.ToString("dd.MM.yyyy HH:mm")</span>
            </div>
        </div>

        <!-- Rapor Detay Bilgileri -->
        <div class="report_detail__content">
            <!-- Temel Bilgiler -->
            <div class="report_detail__section">
                <h2 class="report_detail__section__title">Temel Bilgiler</h2>
                <div class="report_detail__table">
                    <div class="report_detail__table__row">
                        <div class="report_detail__table__cell report_detail__table__cell--label">Rapor No</div>
                        <div class="report_detail__table__cell report_detail__table__cell--value">@report.ReportNumber</div>
                    </div>
                    <div class="report_detail__table__row">
                        <div class="report_detail__table__cell report_detail__table__cell--label">Rapor Tarihi</div>
                        <div class="report_detail__table__cell report_detail__table__cell--value">@report.ReportDate.ToString("dd.MM.yyyy")</div>
                    </div>
                    <div class="report_detail__table__row">
                        <div class="report_detail__table__cell report_detail__table__cell--label">Durum</div>
                        <div class="report_detail__table__cell report_detail__table__cell--value">
                            <span class="report_detail__badge report_detail__badge--@GetStatusClass(report.Status)">
                                @report.StatusText
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kredi Bilgileri -->
            <div class="report_detail__section">
                <h2 class="report_detail__section__title">Kredi Bilgileri</h2>
                <div class="report_detail__table">
                    <div class="report_detail__table__row">
                        <div class="report_detail__table__cell report_detail__table__cell--label">Kredi Tutarı</div>
                        <div class="report_detail__table__cell report_detail__table__cell--value">@FormatCurrency(report.LoanAmount)</div>
                    </div>
                    <div class="report_detail__table__row">
                        <div class="report_detail__table__cell report_detail__table__cell--label">Vade</div>
                        <div class="report_detail__table__cell report_detail__table__cell--value">@report.Term Ay</div>
                    </div>
                    <div class="report_detail__table__row">
                        <div class="report_detail__table__cell report_detail__table__cell--label">Faiz Oranı (Aylık)</div>
                        <div class="report_detail__table__cell report_detail__table__cell--value">%@report.InterestRate.ToString("N2")</div>
                    </div>
                    <div class="report_detail__table__row">
                        <div class="report_detail__table__cell report_detail__table__cell--label">Aylık Taksit</div>
                        <div class="report_detail__table__cell report_detail__table__cell--value">@FormatCurrency(report.MonthlyPayment)</div>
                    </div>
                    <div class="report_detail__table__row">
                        <div class="report_detail__table__cell report_detail__table__cell--label">Toplam Geri Ödeme</div>
                        <div class="report_detail__table__cell report_detail__table__cell--value">@FormatCurrency(report.TotalPayment)</div>
                    </div>
                    <div class="report_detail__table__row">
                        <div class="report_detail__table__cell report_detail__table__cell--label">Toplam Faiz</div>
                        <div class="report_detail__table__cell report_detail__table__cell--value">@FormatCurrency(report.TotalInterest)</div>
                    </div>
                </div>
            </div>

            <!-- Ek Bilgiler -->
            @if (report.AdditionalInfo != null && report.AdditionalInfo.Any())
            {
                <div class="report_detail__section">
                    <h2 class="report_detail__section__title">Ek Bilgiler</h2>
                    <div class="report_detail__table">
                        @foreach (var info in report.AdditionalInfo)
                        {
                            <div class="report_detail__table__row">
                                <div class="report_detail__table__cell report_detail__table__cell--label">@info.Key</div>
                                <div class="report_detail__table__cell report_detail__table__cell--value">@info.Value</div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Rapor İçeriği (JSON) -->
            @if (!string.IsNullOrEmpty(report.Content))
            {
                <div class="report_detail__section">
                    <h2 class="report_detail__section__title">Rapor İçeriği</h2>
                    <div class="report_detail__content__json">
                        <pre class="report_detail__json">@FormatJsonContent(report.Content)</pre>
                    </div>
                </div>
            }
        </div>

        <!-- Print Butonu -->
        <div class="report_detail__actions">
            <button type="button" class="btn_primary" onclick="window.print()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                    <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                </svg>
                Yazdır
            </button>
        </div>
    }
</div>

@functions {
    private string GetStatusClass(int status)
    {
        return status switch
        {
            0 => "pending",    // Bekliyor
            1 => "approved",  // Onaylandı
            2 => "rejected",  // Reddedildi
            _ => "unknown"
        };
    }

    private string FormatCurrency(decimal amount)
    {
        return new System.Globalization.CultureInfo("tr-TR").NumberFormat.CurrencySymbol + 
               amount.ToString("N2", new System.Globalization.CultureInfo("tr-TR"));
    }

    private string FormatJsonContent(string? jsonContent)
    {
        if (string.IsNullOrEmpty(jsonContent))
            return string.Empty;

        try
        {
            // JSON'u formatla
            var jsonObject = Newtonsoft.Json.JsonConvert.DeserializeObject(jsonContent);
            var formatted = Newtonsoft.Json.JsonConvert.SerializeObject(jsonObject, Newtonsoft.Json.Formatting.Indented);
            // XSS koruması için HTML encode (Html.Raw kullanmıyoruz!)
            return System.Net.WebUtility.HtmlEncode(formatted);
        }
        catch
        {
            // JSON değilse direkt göster (HTML encode ile)
            return System.Net.WebUtility.HtmlEncode(jsonContent);
        }
    }
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Print butonu
            $('.report_detail__actions button').on('click', function() {
                window.print();
            });
        });
    </script>
}
